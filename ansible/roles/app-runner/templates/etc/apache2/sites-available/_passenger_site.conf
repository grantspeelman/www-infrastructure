<VirtualHost *:80>
{% if privkey_pem_file.stat.exists == True %}

    ServerName {{server_name}}
    Redirect / https://{{server_name}}/
</VirtualHost>

<VirtualHost *:443>
    # ssl details
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/{{server_name}}/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/{{server_name}}/privkey.pem

    # rails needs the header for its own processing
    RequestHeader set X_FORWARDED_PROTO 'https'
{% endif %}

    ServerName {{server_name}}
    DocumentRoot /home/{{app_deploy_name}}/current/public
    PassengerMinInstances 2

    ServerAdmin info@my-grocery-price-book.co.za

    <Directory /home/{{app_deploy_name}}/current/public>
        Allow from all
        Options -MultiViews
        Require all granted
    </Directory>

    # Rails finger-printed assets, make them cached forever.
    # Try only match if the asset actually has a fingerprint in it.
    <LocationMatch "^/assets/.*$">
      Header unset ETag
      FileETag None
      # RFC says only cache for 1 year
      ExpiresActive On
      ExpiresDefault "access plus 1 year"
    </LocationMatch>
</VirtualHost>